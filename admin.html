<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - mon-app-maths</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            color: #555;
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            box-shadow: 0 10px 20px rgba(108, 117, 125, 0.3);
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 15px;
        }

        .stats-table th,
        .stats-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .stats-table th {
            background: #e9ecef;
            font-weight: 600;
            color: #555;
        }

        .stats-table tr:hover {
            background: #fff9e6;
        }

        .login-container {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
        }

        .login-box {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .login-box h2 {
            color: #667eea;
            margin-bottom: 30px;
        }

        .user-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            color: #004085;
            font-size: 14px;
        }

        .grid-full {
            grid-column: 1 / -1;
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üìä Tableau de Bord Admin</h1>
            <p>Gestion des niveaux, chapitres, ressources, exercices interactifs et stats</p>
        </div>

        <div class="content" id="content">
            <div class="alert alert-info grid-full">
                ‚è≥ Initialisation en cours...
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/+esm';

        const SUPABASE_URL = 'https://fhpfpnlkcvhxotbblzps.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZocGZwbmxrY3ZoeG90YmJsenBzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDQyODI2NTgsImV4cCI6MjAyMDA0MzA1OH0.kV2W5K0D-7bEQ0XQ2RJ8HG3W8F3C4LzH0M0Z9XK5Z8c';
        const ADMIN_EMAIL = 'biram26@yahoo.fr';

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let niveaux = [];
        let chapitres = [];

        async function checkLogin() {
            try {
                const { data } = await supabase.auth.getSession();
                if (data.session) {
                    currentUser = data.session.user;
                    if (currentUser.email !== ADMIN_EMAIL) {
                        showError('Acc√®s refus√©.');
                        await supabase.auth.signOut();
                        return false;
                    }
                    return true;
                }
            } catch (err) {
                console.error('Erreur session:', err);
            }
            return false;
        }

        async function loginAdmin(email, password) {
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                currentUser = data.user;
                showSuccess('Connect√©.');
                renderDashboard();
            } catch (err) {
                showError('Login √©chou√©: ' + err.message);
            }
        }

        async function logoutAdmin() {
            await supabase.auth.signOut();
            currentUser = null;
            renderLogin();
        }

        function renderLogin() {
            document.getElementById('content').innerHTML = `
                <div class="login-container">
                    <div class="login-box">
                        <h2>üîê Connexion Admin</h2>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="loginEmail" value="biram26@yahoo.fr" />
                        </div>
                        <div class="form-group">
                            <label>Mot de passe</label>
                            <input type="password" id="loginPassword" placeholder="Mot de passe Supabase" />
                        </div>
                        <button onclick="window.loginHandler()">Connexion</button>
                        <p style="margin-top: 15px; font-size: 12px; color: #666;">
                            Utilisateur √† cr√©er dans Supabase (Auth ‚Üí Users).
                        </p>
                    </div>
                </div>
            `;
        }

        async function renderDashboard() {
            await loadData();
            document.getElementById('content').innerHTML = `
                <div class="grid-full">
                    <div class="user-info">
                        ‚úÖ Connect√© en tant que <strong>${currentUser.email}</strong>
                        <button class="btn-secondary" onclick="window.logoutHandler()" style="width:auto;padding:6px 16px;margin-left:10px;display:inline-block;">D√©connexion</button>
                    </div>
                </div>

                <div class="section">
                    <h2>üìö Niveaux</h2>
                    <div class="form-group">
                        <label>Nom du niveau</label>
                        <input type="text" id="niveauNom" placeholder="Seconde, Premi√®re..." />
                    </div>
                    <div class="form-group">
                        <label>Ordre</label>
                        <input type="number" id="niveauOrdre" value="1" />
                    </div>
                    <button onclick="window.addNiveauHandler()">‚ûï Ajouter Niveau</button>
                    <table class="stats-table">
                        <thead>
                            <tr><th>Nom</th><th>Ordre</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="niveauxList"></tbody>
                    </table>
                </div>

                <div class="section">
                    <h2>üìñ Chapitres</h2>
                    <div class="form-group">
                        <label>Niveau</label>
                        <select id="chapitrNiveau"></select>
                    </div>
                    <div class="form-group">
                        <label>Nom du chapitre</label>
                        <input type="text" id="chapitreNom" placeholder="Trigonom√©trie..." />
                    </div>
                    <div class="form-group">
                        <label>Ordre</label>
                        <input type="number" id="chapitreOrdre" value="1" />
                    </div>
                    <button onclick="window.addChapitre()">‚ûï Ajouter Chapitre</button>
                    <table class="stats-table">
                        <thead>
                            <tr><th>Chapitre</th><th>Niveau</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="chapitresList"></tbody>
                    </table>
                </div>

                <div class="section">
                    <h2>üì§ Upload Ressources</h2>
                    <div class="form-group">
                        <label>Chapitre</label>
                        <select id="uploadChapitre"></select>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="uploadType">
                            <option value="pdf">PDF</option>
                            <option value="docx">DOCX</option>
                            <option value="tex">TEX</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fichier</label>
                        <input type="file" id="uploadFile" />
                    </div>
                    <button onclick="window.uploadFileHandler()">üìÅ Upload</button>
                </div>

                <div class="section">
                    <h2>üéÆ Exercices Interactifs</h2>
                    <div class="form-group">
                        <label>Chapitre</label>
                        <select id="exercicesChapitre"></select>
                    </div>
                    <div class="form-group">
                        <label>Titre</label>
                        <input type="text" id="exercicesTitre" placeholder="Quiz Sinus 30¬∞..." />
                    </div>
                    <div class="form-group">
                        <label>HTML (contenu)</label>
                        <textarea id="exercicesHtml" rows="4" placeholder="&lt;div&gt;Votre contenu HTML...&lt;/div&gt;"></textarea>
                    </div>
                    <button onclick="window.addExerciceHandler()">‚ûï Cr√©er Exercice</button>
                </div>

                <div class="section grid-full">
                    <h2>üìä Statistiques (simple)</h2>
                    <table class="stats-table">
                        <thead>
                            <tr><th>Exercice</th><th>Chapitre</th><th>Vues</th><th>R√©ussies</th><th>Taux</th></tr>
                        </thead>
                        <tbody id="statsList"></tbody>
                    </table>
                    <button class="btn-secondary" onclick="window.refreshStats()" style="margin-top:15px;">üîÑ Rafra√Æchir Stats</button>
                </div>

                <div id="alerts" class="grid-full"></div>
            `;

            updateSelects();
            await refreshStats();
        }

        async function loadData() {
            try {
                const [nivRes, chapRes] = await Promise.all([
                    supabase.from('niveaux').select('*').order('ordre'),
                    supabase.from('chapitres').select('*').order('ordre')
                ]);
                niveaux = nivRes.data || [];
                chapitres = chapRes.data || [];
                renderNiveaux();
                renderChapitres();
            } catch (err) {
                console.error('Erreur loadData:', err);
                showError('Erreur chargement donn√©es.');
            }
        }

        function renderNiveaux() {
            const tbody = document.getElementById('niveauxList');
            if (!tbody) return;
            tbody.innerHTML = niveaux.map(n => `
                <tr>
                    <td>${n.nom}</td>
                    <td>${n.ordre}</td>
                    <td>
                        <button class="btn-secondary" onclick="window.deleteNiveauHandler('${n.id}')" style="padding:4px 8px;width:auto;">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderChapitres() {
            const tbody = document.getElementById('chapitresList');
            if (!tbody) return;
            tbody.innerHTML = chapitres.map(c => {
                const niv = niveaux.find(n => n.id === c.niveau_id);
                return `
                    <tr>
                        <td>${c.nom}</td>
                        <td>${niv ? niv.nom : '?'}</td>
                        <td>
                            <button class="btn-secondary" onclick="window.deleteChapitre('${c.id}')" style="padding:4px 8px;width:auto;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateSelects() {
            const nivSelect = document.getElementById('chapitrNiveau');
            const chapUpload = document.getElementById('uploadChapitre');
            const chapExos = document.getElementById('exercicesChapitre');

            if (nivSelect) {
                nivSelect.innerHTML = niveaux.map(n => `<option value="${n.id}">${n.nom}</option>`).join('');
            }
            if (chapUpload) {
                chapUpload.innerHTML = chapitres.map(c => `<option value="${c.id}">${c.nom}</option>`).join('');
            }
            if (chapExos) {
                chapExos.innerHTML = chapitres.map(c => `<option value="${c.id}">${c.nom}</option>`).join('');
            }
        }

        window.loginHandler = async function () {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) {
                showError('Email et mot de passe requis.');
                return;
            }
            await loginAdmin(email, password);
        };

        window.logoutHandler = logoutAdmin;

        window.addNiveauHandler = async function () {
            const nom = document.getElementById('niveauNom').value;
            const ordre = parseInt(document.getElementById('niveauOrdre').value) || 1;
            if (!nom) {
                showError('Nom requis.');
                return;
            }
            try {
                const { error } = await supabase.from('niveaux').insert([{ nom, ordre }]);
                if (error) throw error;
                showSuccess('Niveau ajout√©.');
                document.getElementById('niveauNom').value = '';
                await loadData();
            } catch (err) {
                showError(err.message);
            }
        };

        window.deleteNiveauHandler = async function (id) {
            if (!confirm('Supprimer ce niveau ?')) return;
            try {
                const { error } = await supabase.from('niveaux').delete().eq('id', id);
                if (error) throw error;
                showSuccess('Niveau supprim√©.');
                await loadData();
            } catch (err) {
                showError(err.message);
            }
        };

        window.addChapitre = async function () {
            const niveau_id = document.getElementById('chapitrNiveau').value;
            const nom = document.getElementById('chapitreNom').value;
            const ordre = parseInt(document.getElementById('chapitreOrdre').value) || 1;
            if (!nom) {
                showError('Nom du chapitre requis.');
                return;
            }
            try {
                const { error } = await supabase.from('chapitres').insert([{ niveau_id, nom, ordre }]);
                if (error) throw error;
                showSuccess('Chapitre ajout√©.');
                document.getElementById('chapitreNom').value = '';
                await loadData();
            } catch (err) {
                showError(err.message);
            }
        };

        window.deleteChapitre = async function (id) {
            if (!confirm('Supprimer ce chapitre ?')) return;
            try {
                const { error } = await supabase.from('chapitres').delete().eq('id', id);
                if (error) throw error;
                showSuccess('Chapitre supprim√©.');
                await loadData();
            } catch (err) {
                showError(err.message);
            }
        };

        window.uploadFileHandler = async function () {
            const chapitre_id = document.getElementById('uploadChapitre').value;
            const type = document.getElementById('uploadType').value;
            const file = document.getElementById('uploadFile').files[0];

            if (!file || !chapitre_id) {
                showError('Chapitre et fichier requis.');
                return;
            }

            try {
                const chap = chapitres.find(c => c.id === chapitre_id);
                const base = chap ? chap.nom.replace(/\s+/g, '_') : 'inconnu';
                const path = `${base}/${file.name}`;

                const { error } = await supabase.storage.from('cours').upload(path, file, {
                    cacheControl: '3600',
                    upsert: false
                });
                if (error) throw error;
                showSuccess('Fichier upload√©.');
                document.getElementById('uploadFile').value = '';
            } catch (err) {
                showError('Upload √©chou√©: ' + err.message);
            }
        };

        window.addExerciceHandler = async function () {
            const chapitre_id = document.getElementById('exercicesChapitre').value;
            const titre = document.getElementById('exercicesTitre').value;
            const html_content = document.getElementById('exercicesHtml').value;

            if (!titre || !html_content) {
                showError('Titre et HTML requis.');
                return;
            }

            try {
                const { error } = await supabase.from('interactive_exercices').insert([{
                    chapitre_id,
                    titre,
                    html_content
                }]);
                if (error) throw error;
                showSuccess('Exercice cr√©√©.');
                document.getElementById('exercicesTitre').value = '';
                document.getElementById('exercicesHtml').value = '';
            } catch (err) {
                showError(err.message);
            }
        };

        window.refreshStats = async function () {
            try {
                const { data, error } = await supabase
                    .from('stats_exercices')
                    .select('*, interactive_exercices(titre), chapitres(nom)')
                    .order('created_at', { ascending: false });
                if (error) throw error;
                const tbody = document.getElementById('statsList');
                if (!tbody) return;
                tbody.innerHTML = (data || []).map(s => {
                    const taux = s.vues > 0 ? Math.round((s.reussies / s.vues) * 100) : 0;
                    return `
                        <tr>
                            <td>${s.interactive_exercices ? s.interactive_exercices.titre : '?'}</td>
                            <td>${s.chapitres ? s.chapitres.nom : '?'}</td>
                            <td>${s.vues || 0}</td>
                            <td>${s.reussies || 0}</td>
                            <td>${taux}%</td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                showError('Erreur stats: ' + err.message);
            }
        };

        function showSuccess(msg) {
            showAlert(msg, 'success');
        }

        function showError(msg) {
            showAlert(msg, 'error');
        }

        function showAlert(msg, type) {
            const alertsDiv = document.getElementById('alerts');
            if (!alertsDiv) return;
            const id = Date.now();
            const html = `<div class="alert alert-${type}" id="alert-${id}">${msg}</div>`;
            alertsDiv.insertAdjacentHTML('beforeend', html);
            setTimeout(() => {
                const el = document.getElementById(`alert-${id}`);
                if (el) el.remove();
            }, 5000);
        }

        async function init() {
            const ok = await checkLogin();
            if (ok) renderDashboard();
            else renderLogin();
        }

        init();
    </script>
</body>

</html>