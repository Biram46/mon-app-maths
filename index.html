<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Tuteur Maths Robot</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-blue: #2196F3;
            --primary-green: #4CAF50;
            --primary-red: #f44336;
            --bg-dark: #121212;
            --bg-card: rgba(255, 255, 255, 0.05);
            --text-main: #e0e0e0;
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-gold: #FFD700;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* --- Header --- */
        header {
            padding: 1rem 2rem;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(45deg, var(--primary-blue), var(--accent-gold));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .auth-buttons {
            display: flex;
            gap: 1rem;
        }

        button {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        button:active {
            transform: scale(0.95);
        }

        .btn-login {
            background: var(--primary-blue);
            color: white;
        }

        .btn-signup {
            background: var(--primary-green);
            color: white;
        }

        .btn-logout {
            background: var(--primary-red);
            color: white;
            display: none;
        }

        /* --- Layout --- */
        main {
            display: grid;
            grid-template-columns: 25% 1fr 25%;
            gap: 1rem;
            padding: 1rem;
            flex-grow: 1;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        .column {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1.5rem;
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }



        /* --- Chat UI --- */
        .chat-container {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            height: 200px;
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            padding: 0.5rem;
            border-radius: 8px;
            font-size: 0.85rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .chat-message {
            padding: 0.4rem 0.8rem;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
        }

        .user-msg {
            align-self: flex-end;
            background: var(--primary-blue);
            color: white;
        }

        .robot-msg {
            align-self: flex-start;
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
        }

        .chat-input-area {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input-area input {
            flex-grow: 1;
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.05);
            color: white;
            margin: 0;
        }

        /* --- Content Column --- */
        .content-area {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .course-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            padding: 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: 0.3s;
        }

        .course-card:hover {
            border-color: var(--primary-blue);
            background: rgba(33, 150, 243, 0.05);
        }

        /* --- Progress Column --- */
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
        }

        /* --- Modals --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #1e1e1e;
            padding: 2.5rem;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--glass-border);
        }

        form input {
            width: 100%;
            padding: 0.8rem;
            margin: 0.8rem 0;
            background: #2a2a2a;
            border: 1px solid #444;
            color: white;
            border-radius: 6px;
        }

        @media (max-width: 1024px) {
            main {
                grid-template-columns: 1fr;
            }

            .column:nth-child(1),
            .column:nth-child(3) {
                order: 2;
            }

            .column:nth-child(2) {
                order: 1;
            }
        }
    </style>
</head>

<body>

    <header>
        <div class="logo">ü§ñ Robot Maths - Lyc√©e</div>
        <div class="auth-buttons">
            <button class="btn-login" id="btn-admin"
                style="display: none; background: var(--bg-card); border: 1px solid var(--glass-border);"
                onclick="window.location.href='admin.html'">‚öôÔ∏è Admin</button>
            <button class="btn-login" onclick="toggleModal('login-modal')">Connexion</button>
            <button class="btn-signup" onclick="toggleModal('signup-modal')">Inscription</button>
            <button class="btn-logout" onclick="handleLogout()">D√©connexion</button>
        </div>
    </header>

    <main id="app-content" style="display: none;">
        <!-- Navigation Sidebar -->
        <aside class="column">
            <div style="margin-bottom: 2 Brem;">
                <h3 style="color: var(--accent-gold); margin-bottom: 1rem;">üìö Par Niveau</h3>
                <div id="level-nav" style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <!-- Levels loaded here -->
                    <p style="opacity: 0.5; font-size: 0.8rem;">Chargement des niveaux...</p>
                </div>
            </div>

            <div style="margin-top: 2rem;">
                <h3>Votre Progression</h3>
                <div id="stats-container">
                    <div class="stat-item"><span>Exercices finis</span> <b id="stat-done">0</b></div>
                    <div class="stat-item"><span>Pr√©cision</span> <b id="stat-accuracy">0%</b></div>
                    <div class="stat-item"><span>Niveau Robot</span> <b id="stat-level">D√©butant</b></div>
                </div>
            </div>

            <div
                style="margin-top: 2rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 12px; border: 1px solid var(--glass-border);">
                <h4>Tuteur Virtuel</h4>
                <canvas id="robot-canvas-small" style="width: 100%; aspect-ratio: 1;"></canvas>
                <div id="robot-speech-small" style="font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.8;">
                    Pr√™t pour le cours ?
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <section class="column content-area" id="main-view">
            <div id="content-header">
                <h2>Bienvenue sur Robot Maths</h2>
                <p>S√©lectionnez un niveau dans la barre lat√©rale pour commencer.</p>
            </div>
            <div id="dynamic-content">
                <!-- Chapters or Resources injected here -->
                <div style="display: flex; justify-content: center; align-items: center; min-height: 200px;">
                    <img src="math_robot_hero.png" style="max-width: 200px; opacity: 0.3;" alt="Robot">
                </div>
            </div>
        </section>

        <!-- Chat / Robot Hub -->
        <aside class="column">
            <h3>ü§ñ Aide & Chat</h3>
            <div class="chat-container" style="height: 400px;">
                <div id="chat-messages" style="height: 320px;"></div>
                <div class="chat-input-area">
                    <input type="text" id="chat-input" placeholder="Pose une question..."
                        onkeypress="if(event.key === 'Enter') sendChatMessage()">
                    <button onclick="sendChatMessage()" style="padding: 0.5rem;">üöÄ</button>
                </div>
            </div>
        </aside>
    </main>

    <div id="welcome-screen"
        style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 2rem;">
        <h1>Apprends les maths avec un Robot üöÄ</h1>
        <p style="margin: 1rem 0 2rem; opacity: 0.8;">Connecte-toi pour commencer ton aventure.</p>
        <img src="math_robot_hero.png" alt="Robot Preview"
            style="border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 100%; height: auto;">
    </div>

    <!-- Modals -->
    <div id="login-modal" class="modal" onclick="closeOnOverlay(event)">
        <div class="modal-content">
            <h2>Heureux de vous revoir !</h2>
            <form onsubmit="handleAuth(event, 'login')">
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Mot de passe" required>
                <button type="submit" class="btn-login" style="width: 100%;">Se connecter</button>
            </form>
        </div>
    </div>

    <div id="signup-modal" class="modal" onclick="closeOnOverlay(event)">
        <div class="modal-content">
            <h2>Cr√©er un compte</h2>
            <form onsubmit="handleAuth(event, 'signup')">
                <input type="email" id="signup-email" placeholder="Email" required>
                <input type="password" id="signup-password" placeholder="Mot de passe" required>
                <button type="submit" class="btn-signup" style="width: 100%;">S'inscrire</button>
            </form>
        </div>
    </div>

    <!-- Interactive Exercise Modal -->
    <div id="interactive-modal" class="modal" onclick="closeOnOverlay(event)">
        <div class="modal-content" style="max-width: 600px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h2 id="interactive-title" style="color:var(--accent-gold);">Exercices Interactifs</h2>
                <button onclick="toggleModal('interactive-modal')"
                    style="background:none; border:none; color:white; font-size:1.5rem;">&times;</button>
            </div>
            <div id="interactive-body">
                <!-- Dynamic Content -->
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // --- CONFIG SUPABASE ---
        const SUPABASE_URL = window.APP_CONFIG.SUPABASE_URL;
        const SUPABASE_KEY = window.APP_CONFIG.SUPABASE_KEY;
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        /* 
        IMPORTANT: Pour que la section EAM fonctionne, vous devez ajouter la colonne 'category' et 'type' √† votre table 'courses' dans Supabase.
        Ex√©cutez ce SQL dans l'√©diteur SQL de Supabase :
        
        ALTER TABLE courses ADD COLUMN category TEXT DEFAULT 'standard';
        ALTER TABLE courses ADD COLUMN type TEXT DEFAULT 'standard';
        */

        // --- GLOBAL VARIABLES (Moved to top) ---
        let currentUser = null;
        let isRobotSpeaking = false;
        let userProgress = { completed: [], score: 0 };
        let currentLevels = [];

        // --- AUTH LOGIC ---
        async function handleAuth(e, type) {
            e.preventDefault();
            const email = document.getElementById(`${type}-email`).value;
            const password = document.getElementById(`${type}-password`).value;

            try {
                let result;
                if (type === 'signup') {
                    result = await supabaseClient.auth.signUp({ email, password });
                    alert("V√©rifiez votre email !");
                } else {
                    result = await supabaseClient.auth.signInWithPassword({ email, password });
                }

                if (result.error) throw result.error;
                toggleModal(`${type}-modal`);
            } catch (err) {
                alert(err.message);
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
        }

        // Listen for Auth changes
        supabaseClient.auth.onAuthStateChange((event, session) => {
            const loggedIn = !!session;
            document.querySelector('.btn-login').style.display = loggedIn ? 'none' : 'block';
            document.querySelector('.btn-signup').style.display = loggedIn ? 'none' : 'block';
            document.querySelector('.btn-logout').style.display = loggedIn ? 'block' : 'none';
            document.getElementById('btn-admin').style.display = loggedIn ? 'block' : 'none';

            // TOUJOURS afficher l'interface principale pour tester, m√™me si pas connect√© (optionnel, selon votre besoin)
            // Pour l'instant on garde la logique : connect√© = app visible
            document.getElementById('app-content').style.display = loggedIn ? 'grid' : 'none';
            document.getElementById('welcome-screen').style.display = loggedIn ? 'none' : 'flex';

            if (loggedIn) {
                initApp(session.user);
            }
        });

        // --- NEW HIERARCHICAL LOGIC ---


        async function initApp(user) {
            console.log("Initialisation de l'app pour :", user.email);
            currentUser = user;
            await loadUserProgress();
            await loadLevels(); // Appel des niveaux
            updateStatsUI();
            startRobot();
        }

        async function loadLevels() {
            console.log("D√©but chargement niveaux...");
            try {
                const { data, error } = await supabaseClient
                    .from('levels')
                    .select('*')
                    .order('display_order');

                if (error) {
                    console.error("Erreur Supabase re√ßue :", error);
                    throw error;
                }

                console.log("Donn√©es niveaux re√ßues :", data);

                if (data && data.length > 0) {
                    currentLevels = data;
                    const nav = document.getElementById('level-nav');
                    nav.innerHTML = data.map(lvl => `
                        <button onclick="showChapters(${lvl.id}, '${lvl.name}')" 
                            style="background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); text-align: left; width: 100%; color: white; padding: 0.8rem; border-radius: 8px;">
                            ${lvl.name}
                        </button>
                    `).join('');
                } else {
                    document.getElementById('level-nav').innerHTML = '<p style="opacity:0.5; font-size:0.8rem;">Aucun niveau.</p>';
                    console.warn("Table levels vide ou illisible.");
                }
            } catch (err) {
                console.error("Erreur niveaux:", err);
                document.getElementById('level-nav').innerHTML = '<p style="color:red; font-size:0.8rem;">Erreur.</p>';
                alert("Erreur chargement niveaux : " + err.message);
            }
        }
        function toggleModal(id) {
            const modal = document.getElementById(id);
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }

        function closeOnOverlay(e) {
            if (e.target.className === 'modal') e.target.style.display = 'none';
        }

        // --- ROBOT ENGINE ---
        // Canvas initialized strictly inside startRobot to avoid null errors
        let canvas, ctx;
        let blinkTimer = 0;

        function startRobot() {
            canvas = document.getElementById('robot-canvas'); // May be null if not in DOM? No, it should be removed or commented out if not used.
            ctx = canvas ? canvas.getContext('2d') : null;
            // Wait, looking at HTML structure, main canvas 'robot-canvas' is missing from 'main'. 
            // Only 'robot-canvas-small' exists in the sidebar.
            // Adjusting code to be safe.

            const smallCanvas = document.getElementById('robot-canvas-small');
            if (smallCanvas) {
                smallCanvas.width = 400;
                smallCanvas.height = 400;
            }
            requestAnimationFrame(animateRobot);
        }

        const blinkTimerMax = 200;
        function animateRobot(time) {
            const canvases = [canvas, document.getElementById('robot-canvas-small')].filter(c => c !== null);
            canvases.forEach(canv => {
                const cctx = canv.getContext('2d');
                cctx.clearRect(0, 0, 400, 400);

                // Body/Head (Gold Gradient)
                const grad = cctx.createRadialGradient(200, 200, 50, 200, 200, 150);
                grad.addColorStop(0, '#FFD700');
                grad.addColorStop(1, '#B8860B');

                cctx.beginPath();
                cctx.arc(200, 200, 100, 0, Math.PI * 2);
                cctx.fillStyle = grad;
                cctx.fill();
                cctx.strokeStyle = 'rgba(255,255,255,0.3)';
                cctx.lineWidth = 5;
                cctx.stroke();

                // Eyes
                const eyeY = 180 + Math.sin(time / 500) * 5;
                blinkTimer++;
                const isBlinking = blinkTimer % blinkTimerMax > 190;

                cctx.fillStyle = '#000';
                // Left Eye
                if (isBlinking) {
                    cctx.fillRect(160, eyeY, 20, 2);
                } else {
                    cctx.beginPath();
                    cctx.arc(160, eyeY, 12, 0, Math.PI * 2);
                    cctx.fill();
                    cctx.fillStyle = '#00FFFF';
                    cctx.beginPath();
                    cctx.arc(160, eyeY, 5, 0, Math.PI * 2);
                    cctx.fill();
                }

                // Right Eye
                cctx.fillStyle = '#000';
                if (isBlinking) {
                    cctx.fillRect(220, eyeY, 20, 2);
                } else {
                    cctx.beginPath();
                    cctx.arc(220, eyeY, 12, 0, Math.PI * 2);
                    cctx.fill();
                    cctx.fillStyle = '#00FFFF';
                    cctx.beginPath();
                    cctx.arc(220, eyeY, 5, 0, Math.PI * 2);
                    cctx.fill();
                }

                // Mouth (Animation when speaking)
                cctx.strokeStyle = '#000';
                cctx.beginPath();
                cctx.moveTo(170, 240);
                const mouthWave = isRobotSpeaking ? Math.sin(time / 50) * 15 : Math.sin(time / 200) * 5;
                cctx.quadraticCurveTo(200, 250 + mouthWave, 230, 240);
                cctx.stroke();
            });

            requestAnimationFrame(animateRobot);
        }

        // --- CONTENT DATA ---
        const COURSES = [
            {
                id: 1,
                title: "Les Nombres Entiers",
                desc: "Ma√Ætriser l'addition et la soustraction.",
                theory: "Les nombres entiers sont les nombres que nous utilisons pour compter : 0, 1, 2, 3... <b>L'addition</b> permet de combiner deux quantit√©s. Par exemple, 5 + 3 = 8. <b>La soustraction</b> permet de trouver la diff√©rence : 10 - 4 = 6.",
                exercises: [
                    { question: "Combien font 12 + 15 ?", answer: 27 },
                    { question: "Si j'ai 20 pommes et j'en mange 7, combien m'en reste-t-il ?", answer: 13 }
                ]
            },
            {
                id: 2,
                title: "Multiplication & Division",
                desc: "Les bases du calcul rapide.",
                theory: "La <b>multiplication</b> est une addition r√©p√©t√©e. 3 √ó 4 c'est 4 + 4 + 4 = 12. La <b>division</b> est l'op√©ration inverse : on partage une quantit√© en parts √©gales. 12 √∑ 3 = 4 car 4 + 4 + 4 = 12.",
                exercises: [
                    { question: "Combien font 6 √ó 7 ?", answer: 42 },
                    { question: "Partage 24 billes entre 4 amis. Combien en ont-ils chacun ?", answer: 6 }
                ]
            },
            {
                id: 3,
                title: "Les Fractions",
                desc: "Comprendre les parts d'un tout.",
                theory: "Une fraction repr√©sente une partie d'une unit√©. Par exemple, 1/2 c'est la moiti√© de quelque chose. Le chiffre du haut est le <b>num√©rateur</b> (combien de parts on a), le bas est le <b>d√©nominateur</b> (en combien de parts l'unit√© est coup√©e).",
                exercises: [
                    { question: "Si je coupe un g√¢teau en 4 et j'en prends 2 parts, quelle fraction ai-je (en simplifi√©, 1 pour 1/2) ?", answer: 2 },
                    { question: "Quelle est la moiti√© de 50 ?", answer: 25 }
                ]
            },
            {
                id: 4,
                title: "G√©om√©trie Plane",
                desc: "Angles, triangles et polygones.",
                theory: "La g√©om√©trie √©tudie les formes. Un <b>triangle</b> a 3 c√¥t√©s. Un <b>carr√©</b> a 4 c√¥t√©s √©gaux et 4 angles droits. La somme des angles d'un triangle est toujours 180¬∞.",
                exercises: [
                    { question: "Combien de c√¥t√©s poss√®de un hexagone ?", answer: 6 },
                    { question: "Si un carr√© a un c√¥t√© de 5cm, quelle est sa surface (en cm¬≤) ?", answer: 25 }
                ]
            },
            {
                id: 5,
                title: "Calcul de P√©rim√®tres",
                desc: "Mesurer les contours.",
                theory: "Le <b>p√©rim√®tre</b> est la longueur du contour d'une figure plate. Pour un rectangle, c'est (Longueur + largeur) √ó 2. Pour un carr√©, c'est C√¥t√© √ó 4.",
                exercises: [
                    { question: "P√©rim√®tre d'un carr√© de 10 m de c√¥t√© ?", answer: 40 },
                    { question: "P√©rim√®tre d'un rectangle de 5m sur 3m ?", answer: 16 }
                ]
            }
        ];



        async function loadUserProgress() {
            try {
                const { data, error } = await supabaseClient
                    .from('user_stats')
                    .select('progress_data')
                    .eq('user_id', currentUser.id)
                    .single();

                if (data) {
                    userProgress = data.progress_data || { completed: [], score: 0 };
                }
            } catch (err) {
                console.warn("Pas de progression trouv√©e, initialisation...");
            }
        }

        async function saveProgress() {
            if (!currentUser) return;
            const { error } = await supabaseClient
                .from('user_stats')
                .upsert({
                    user_id: currentUser.id,
                    progress_data: userProgress,
                    updated_at: new Date()
                });
            if (error) console.error("Erreur sauvegarde progression:", error);
            updateStatsUI();
        }

        function updateStatsUI() {
            document.getElementById('stat-done').innerText = userProgress.completed.length;
            document.getElementById('stat-done-text').innerText = userProgress.completed.length; // Si utilis√© ailleurs
            document.getElementById('stat-accuracy').innerText = "100%"; // Placeholder

            let rank = "D√©butant";
            if (userProgress.score > 50) rank = "Initi√©";
            if (userProgress.score > 200) rank = "Expert";
            document.getElementById('stat-level').innerText = rank;
        }

        async function showChapters(levelId, levelName) {
            document.getElementById('content-header').innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button onclick="location.reload()" style="background: none; border: 1px solid; color: var(--primary-blue); padding: 5px 10px;">‚Üê</button>
                    <h2>${levelName}</h2>
                </div>
                <p>Choisissez un chapitre pour voir les ressources.</p>
            `;

            const { data: chapters, error } = await supabaseClient
                .from('chapters')
                .select('*')
                .eq('level_id', levelId)
                .order('display_order');

            const content = document.getElementById('dynamic-content');
            if (chapters && chapters.length > 0) {
                content.innerHTML = `<div style="display: flex; flex-direction: column; gap: 1rem;">
                    ${chapters.map(ch => `
                        <div class="course-card" onclick="showResources(${ch.id}, '${ch.title}', '${levelName}')">
                            <h3>${ch.title}</h3>
                            <p style="font-size: 0.8rem; opacity: 0.7;">Cliquez pour voir les cours et exercices</p>
                        </div>
                    `).join('')}
                </div>`;
            } else {
                content.innerHTML = `<p style="text-align: center; opacity: 0.5; margin-top: 2rem;">Aucun chapitre disponible pour ce niveau.</p>`;
            }
            updateRobotSpeech(`On explore le niveau ${levelName}. Quel chapitre t'int√©resse ?`);
        }

        async function showResources(chapterId, chapterTitle, levelName) {
            document.getElementById('content-header').innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button onclick="showChapters(${currentLevels.find(l => l.name === levelName).id}, '${levelName}')" style="background: none; border: 1px solid; color: var(--primary-blue); padding: 5px 10px;">‚Üê</button>
                    <h2>${chapterTitle}</h2>
                </div>
            `;

            const { data: resources, error } = await supabaseClient
                .from('resources')
                .select('*')
                .eq('chapter_id', chapterId);

            const content = document.getElementById('dynamic-content');
            if (resources && resources.length > 0) {
                const cours = resources.filter(r => r.type === 'cours');
                const ex = resources.filter(r => r.type === 'exercice');

                content.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h3 style="margin-bottom: 1rem; border-bottom: 2px solid var(--primary-blue); display: inline-block;">üìë Cours</h3>
                            ${renderResourceList(cours)}
                        </div>
                        <div>
                            <h3 style="margin-bottom: 1rem; border-bottom: 2px solid var(--primary-green); display: inline-block;">‚úèÔ∏è Exercices</h3>
                            ${renderResourceList(ex)}
                        </div>
                    </div>
                `;
            } else {
                content.innerHTML = `<p style="text-align: center; opacity: 0.5; margin-top: 2rem;">Aucune ressource pour ce chapitre.</p>`;
            }
        }

        function openInteractive(courseId) {
            const course = COURSES.find(c => c.id == courseId);
            if (!course) {
                alert("D√©sol√©, contenu interactif introuvable pour cet ID : " + courseId);
                return;
            }

            document.getElementById('interactive-title').innerText = "ü§ñ " + course.title;
            const container = document.getElementById('interactive-body');

            // Build the quiz UI
            container.innerHTML = `
                <div style="background:rgba(255,255,255,0.05); padding:1rem; border-radius:8px; margin-bottom:1rem;">
                    <p><b>Th√©orie :</b> ${course.theory}</p>
                </div>
                ${course.exercises.map((ex, idx) => `
                    <div style="margin-bottom: 1.5rem; border-bottom:1px solid var(--glass-border); padding-bottom:1rem;">
                        <p style="margin-bottom:0.5rem;">Q${idx + 1}: ${ex.question}</p>
                        <div style="display:flex; gap:0.5rem;">
                            <input type="number" id="ans-${courseId}-${idx}" placeholder="Votre r√©ponse" style="flex-grow:1; padding:0.5rem;">
                            <button onclick="checkAnswer(${courseId}, ${idx}, ${ex.answer})" style="background:var(--primary-blue);">V√©rifier</button>
                        </div>
                        <span id="feedback-${courseId}-${idx}" style="font-weight:bold; margin-top:0.5rem; display:block;"></span>
                    </div>
                `).join('')}
            `;

            updateRobotSpeech(`C'est parti pour les exercices sur : ${course.title} !`);
            toggleModal('interactive-modal');
        }

        function renderResourceList(list) {
            if (list.length === 0) return `<p style="opacity: 0.5; font-style: italic;">Bient√¥t disponible...</p>`;
            return list.map(r => `
                <div class="admin-card" style="margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.02);">
                    <h4 style="margin-bottom: 0.8rem;">${r.title}</h4>
                    <div style="display: flex; gap: 10px;">
                        ${r.pdf_url ? `<a href="${r.pdf_url}" target="_blank" title="PDF" style="text-decoration: none; font-size: 1.2rem;">üìï</a>` : ''}
                        ${r.docx_url ? `<a href="${r.docx_url}" target="_blank" title="Word" style="text-decoration: none; font-size: 1.2rem;">üìò</a>` : ''}
                        ${r.latex_url ? `<a href="${r.latex_url}" target="_blank" title="LaTeX" style="text-decoration: none; font-size: 1.2rem;">üìô</a>` : ''}
                        ${r.interactive_id ? `<button onclick="openInteractive(${r.interactive_id})" style="padding: 2px 8px; font-size: 0.7rem; background: var(--accent-gold); color: black;">Mode Interactif</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function checkAnswer(courseId, exIdx, correct) {
            const input = document.getElementById(`ans-${courseId}-${exIdx}`);
            const feedback = document.getElementById(`feedback-${courseId}-${exIdx}`);
            const val = parseInt(input.value);

            if (val === correct) {
                feedback.innerHTML = " ‚úÖ BRAVO !";
                feedback.style.color = "var(--primary-green)";
                updateRobotSpeech("C'est la bonne r√©ponse ! Impressionnant.");

                // Update progress
                if (!userProgress.completed.includes(courseId)) {
                    userProgress.completed.push(courseId);
                    userProgress.score += 10;
                    await saveProgress();
                }
            } else {
                feedback.innerHTML = " ‚ùå Essaie encore";
                feedback.style.color = "var(--primary-red)";
                updateRobotSpeech("Presque ! R√©fl√©chis bien √† la th√©orie.");
            }
        }

        // --- NEW CHAT LOGIC ---
        function updateRobotSpeech(text) {
            // Update both robot areas if they exist
            if (document.getElementById('robot-speech')) document.getElementById('robot-speech').innerText = text;
            if (document.getElementById('robot-speech-small')) document.getElementById('robot-speech-small').innerText = text;

            addChatMessage(text, 'robot');
            isRobotSpeaking = true;
            setTimeout(() => isRobotSpeaking = false, 3000);
        }

        function addChatMessage(text, sender) {
            const container = document.getElementById('chat-messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message ${sender}-msg`;
            msgDiv.innerText = text;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            addChatMessage(text, 'user');
            input.value = '';

            // Simple Logic for Robot Responses
            setTimeout(() => {
                let response = "Je n'ai pas bien compris, mais je suis l√† pour t'aider en maths !";
                const lowerText = text.toLowerCase();

                if (lowerText.includes("aide") || lowerText.includes("aider")) {
                    response = "Bien s√ªr ! Choisis un cours dans la liste au milieu pour que nous commencions.";
                } else if (lowerText.includes("bonjour") || lowerText.includes("salut")) {
                    response = "Bonjour ! Pr√™t √† devenir un champion des math√©matiques ?";
                } else if (lowerText.includes("merci")) {
                    response = "De rien ! Ma mission est de te voir r√©ussir.";
                } else if (lowerText.includes("difficile")) {
                    response = "Les maths demandent de la pratique, mais avec moi, tu vas progresser vite !";
                }

                updateRobotSpeech(response);
            }, 1000);
        }


    </script>
</body>

</html>